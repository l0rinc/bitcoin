// Copyright (c) The Bitcoin Core developers
// Distributed under the MIT software license, see the accompanying
// file COPYING or https://opensource.org/license/mit/.

#include <bench/bench.h>
#include <random.h>
#include <span.h>
#include <streams.h>

#include <cmath>
#include <cstddef>
#include <map>
#include <vector>

static void XorHistogram(benchmark::Bench& bench)
{
    // The histogram represents util::Xor method's write.size() histograms for the first 670k blocks, aggregated using:
    // awk '{ count[$1]++ } END { for (val in count) { printf "{%s, %.0f},\n", val, count[val] } }' histogram.txt
    const std::map<size_t, uint64_t> raw_histogram{
        {1, 23'436'860'420},
        {2, 132'542'545},
        {3, 5'143},
        {4, 8'414'140'329},
        {5, 1'877},
        {6, 50'358},
        {7, 126'810},
        {8, 3'226'072'678},
        {9, 244'013},
        {10, 105'982},
        {11, 818'120},
        {12, 122'941},
        {13, 88'781},
        {14, 76'796},
        {15, 67'145},
        {16, 81'019},
        {17, 65'581},
        {18, 52'118},
        {19, 57'605},
        {20, 52'895},
        {21, 1'442'524'861},
        {22, 232'110'963},
        {23, 1'212'515'864},
        {24, 11'878},
        {25, 2'193'569'763},
        {26, 22'574'077},
        {27, 40'616'330},
        {28, 20'758'405},
        {29, 2'038'749},
        {30, 1'507'867},
        {31, 52'138},
        {32, 3'000'188'840},
        {33, 540'488'314},
        {34, 17'177'619},
        {35, 146'047'971},
        {36, 173'694},
        {37, 19'433'377},
        {38, 647'432},
        {39, 215'592},
        {40, 63'815},
        {41, 398'352},
        {42, 1'505'966},
        {43, 140'241},
        {44, 108'490},
        {45, 15'012},
        {46, 62'143},
        {47, 56'810},
        {48, 501'004},
        {49, 10'522},
        {50, 11'461},
        {51, 10'320},
        {52, 17'143},
        {53, 235'908},
        {54, 7'054},
        {55, 10'541},
        {56, 394'240},
        {57, 16'558},
        {58, 27'621},
        {59, 31'153},
        {60, 11'180},
        {61, 7'979},
        {62, 45'949},
        {63, 18'472},
        {64, 47'098},
        {65, 10'718},
        {66, 122'254},
        {67, 1'740'024},
        {68, 28'546},
        {69, 57'829},
        {70, 3'726'043},
        {71, 564'311'436},
        {72, 301'498'162},
        {73, 3'538'648},
        {74, 707'659},
        {75, 55'953},
        {76, 24'906},
        {77, 350'360},
        {78, 31'827},
        {79, 15'030},
        {80, 15'863},
        {81, 11'955},
        {82, 25'794},
        {83, 46'776'720},
        {84, 15'289},
        {85, 29'487},
        {86, 11'248},
        {87, 4'333},
        {88, 666'648},
        {89, 7'735},
        {90, 6'169},
        {91, 19'019},
        {92, 10'826},
        {93, 11'489},
        {94, 34'877},
        {95, 3'960'339},
        {96, 50'850},
        {97, 210'669},
        {98, 109'187},
        {99, 176'552},
        {100, 271'792},
        {101, 977},
        {102, 4},
        {103, 66'746},
        {104, 56'932},
        {105, 88'049'866},
        {106, 900'349'146},
        {107, 861'969'533},
        {108, 22'990'567},
        {109, 48'380},
        {110, 69'860},
        {111, 501'543},
        {112, 311'514},
        {113, 1'772},
        {114, 290},
        {115, 1'635},
        {116, 1'328},
        {117, 35},
        {118, 8},
        {122, 8},
        {123, 12},
        {125, 10},
        {126, 4'558},
        {127, 1'102'664},
        {128, 4},
        {129, 6},
        {130, 2'256},
        {131, 248},
        {132, 33'594},
        {133, 17'870},
        {134, 41},
        {135, 86'011},
        {136, 5'059},
        {137, 930'396},
        {138, 102'022'670},
        {139, 139'278'630},
        {140, 37'558'870},
        {141, 657},
        {142, 5'093},
        {143, 7'982},
        {144, 79'395},
        {145, 881'817},
        {146, 874'515},
        {147, 3'012},
        {148, 3'861},
        {149, 21},
        {150, 16},
        {151, 14},
        {152, 4},
        {153, 4},
        {154, 445},
        {155, 510},
        {156, 149},
        {157, 151},
        {159, 4},
        {160, 6},
        {161, 6},
        {162, 10},
        {163, 1'983},
        {164, 233'819},
        {165, 236'031},
        {166, 14'253},
        {167, 14'895},
        {168, 136},
        {169, 120},
        {170, 5},
        {171, 12},
        {172, 26},
        {173, 126'390},
        {174, 14},
        {175, 13},
        {176, 21},
        {177, 14},
        {178, 1'735},
        {179, 2'120},
        {180, 45'915},
        {181, 45'600},
        {182, 60},
        {183, 26},
        {184, 2},
        {185, 50},
        {186, 154},
        {187, 83},
        {188, 58},
        {189, 237},
        {190, 319},
        {191, 83},
        {192, 46},
        {193, 72},
        {194, 10},
        {195, 96},
        {196, 109},
        {197, 18},
        {198, 87'749},
        {199, 20},
        {200, 20},
        {201, 33'598},
        {202, 78},
        {203, 89},
        {204, 6},
        {205, 24},
        {206, 78},
        {207, 21'291},
        {208, 153},
        {209, 35},
        {210, 202},
        {211, 460},
        {212, 262},
        {213, 59},
        {214, 7'590},
        {215, 10'092},
        {216, 200'573},
        {217, 12'968'837},
        {218, 25'356'848},
        {219, 12'752'226},
        {220, 93'557},
        {221, 21'412},
        {222, 168},
        {223, 184},
        {224, 22},
        {225, 48},
        {226, 38},
        {227, 493},
        {228, 1'023},
        {229, 718},
        {230, 381},
        {231, 170},
        {232, 4},
        {234, 19},
        {235, 206},
        {236, 186},
        {237, 2},
        {238, 4},
        {239, 510},
        {240, 14'073},
        {241, 29'367},
        {242, 14'123},
        {243, 422},
        {244, 19},
        {245, 46},
        {246, 21},
        {247, 40},
        {248, 4'848},
        {249, 5'263},
        {250, 21'323},
        {251, 638'653},
        {252, 40'671'448},
        {253, 75'115'751},
        {254, 36'299'548},
        {255, 141'829},
        {256, 21'146},
        {257, 26},
        {258, 4},
        {259, 2},
        {260, 15},
        {261, 1'058},
        {262, 2'038},
        {263, 1'085},
        {264, 210},
        {265, 152},
        {266, 444},
        {267, 27},
        {268, 14},
        {269, 8},
        {270, 2},
        {272, 4},
        {274, 14},
        {275, 399},
        {276, 411},
        {277, 70},
        {278, 120},
        {279, 1'433},
        {280, 1'461},
        {281, 83},
        {282, 8'226},
        {283, 14'408},
        {284, 262'632},
        {285, 336'008},
        {286, 329'860},
        {287, 315'521},
        {288, 158'213},
        {289, 149},
        {290, 48},
        {291, 8},
        {292, 10},
        {293, 4},
        {294, 12},
        {295, 8},
        {297, 3},
        {298, 4},
        {299, 2},
        {301, 2},
        {302, 6},
        {303, 2},
        {304, 2},
        {305, 2},
        {306, 2},
        {307, 32},
        {308, 1'824},
        {309, 1'803},
        {311, 2},
        {312, 2},
        {313, 2},
        {314, 42},
        {315, 89},
        {316, 2'205},
        {317, 5'019},
        {318, 3'929},
        {319, 11'178},
        {320, 33'520},
        {321, 38'199},
        {322, 17'271},
        {323, 5'204},
        {324, 30'224},
        {325, 18'814},
        {326, 19'235},
        {327, 6'902},
        {328, 570},
        {329, 250},
        {330, 80},
        {331, 38},
        {332, 16},
        {333, 827},
        {334, 10},
        {335, 18},
        {336, 2},
        {337, 6},
        {338, 4},
        {339, 4},
        {343, 808},
        {344, 1'532},
        {345, 754},
        {346, 93},
        {347, 8'826},
        {348, 580'120},
        {349, 1'122'510},
        {350, 572'000},
        {351, 8'239},
        {352, 2'007},
        {353, 3'979},
        {354, 256'827},
        {355, 506'621},
        {356, 254'375},
        {357, 591},
        {358, 23'244},
        {359, 67'412},
        {360, 71'120},
        {361, 29'164},
        {362, 4'798},
        {363, 1'732},
        {364, 391},
        {365, 25},
        {366, 4},
        {367, 4},
        {368, 16},
        {369, 62},
        {370, 34},
        {371, 14},
        {373, 2},
        {375, 5},
        {377, 5'846},
        {380, 2},
        {382, 2},
        {383, 4},
        {384, 2},
        {385, 12},
        {386, 6},
        {387, 10},
        {388, 221},
        {389, 425},
        {390, 291},
        {391, 6'179},
        {392, 268'300},
        {393, 768'493},
        {394, 765'927},
        {395, 254'550},
        {396, 190},
        {397, 144},
        {398, 116},
        {399, 68},
        {400, 22},
        {401, 33},
        {402, 22},
        {403, 18},
        {404, 12},
        {405, 18},
        {406, 12},
        {408, 2},
        {409, 4},
        {411, 2},
        {414, 10},
        {415, 686},
        {416, 1'840},
        {417, 1'993},
        {418, 1'019},
        {419, 281},
        {420, 52},
        {421, 144},
        {422, 189},
        {423, 841},
        {424, 1'483},
        {425, 1'023},
        {426, 8'090},
        {427, 22'943},
        {428, 22'410},
        {429, 7'530},
        {430, 208},
        {431, 737},
        {432, 1'100},
        {433, 726},
        {434, 204},
        {436, 2},
        {438, 6},
        {439, 2},
        {440, 4},
        {453, 2},
        {454, 2},
        {456, 10},
        {457, 535},
        {458, 1'000},
        {459, 643},
        {460, 5'920},
        {461, 16'751},
        {462, 16'861},
        {463, 6'360},
        {464, 2'643},
        {465, 6'219},
        {466, 8'063},
        {467, 5'552},
        {468, 1'402},
        {470, 4},
        {471, 2},
        {472, 2},
        {473, 6},
        {474, 2},
        {475, 4},
        {476, 2},
        {477, 2},
        {481, 13},
        {482, 22},
        {483, 20},
        {484, 20},
        {485, 395},
        {486, 33'750},
        {487, 1'479'710},
        {488, 4'218'690},
        {489, 4'135'541},
        {490, 1'366'993},
        {491, 830},
        {492, 343},
        {493, 60},
        {494, 9},
        {495, 343},
        {496, 1'131},
        {497, 1'129},
        {498, 3'686},
        {499, 12'353},
        {500, 18'292},
        {501, 12'103},
        {502, 3'009},
        {504, 2},
        {511, 2},
        {513, 44},
        {514, 2},
        {515, 2},
        {516, 2},
        {517, 2},
        {522, 2},
        {523, 6},
        {524, 4},
        {525, 6},
        {526, 4},
        {528, 2},
        {529, 12},
        {530, 32},
        {531, 30},
        {532, 581},
        {533, 2'237},
        {534, 3'242},
        {535, 2'155},
        {536, 608},
        {537, 227},
        {538, 464},
        {539, 434},
        {540, 245},
        {541, 1'814},
        {542, 1'840},
        {543, 2},
        {544, 6},
        {545, 2},
        {546, 2},
        {547, 10},
        {548, 14},
        {549, 12},
        {551, 2},
        {552, 75},
        {553, 3'449},
        {554, 10'519},
        {555, 10'550},
        {556, 3'736},
        {557, 240},
        {558, 110},
        {559, 28},
        {560, 8},
        {561, 24},
        {562, 18},
        {563, 24},
        {564, 26},
        {565, 14},
        {566, 2},
        {568, 6},
        {569, 10},
        {570, 6},
        {571, 22},
        {572, 30},
        {573, 22},
        {574, 26},
        {575, 8},
        {577, 2},
        {580, 2},
        {581, 4},
        {583, 8},
        {584, 60},
        {585, 58},
        {587, 4},
        {588, 2},
        {589, 36},
        {590, 24},
        {591, 2},
        {592, 4},
        {595, 24},
        {596, 14},
        {597, 2},
        {598, 4},
        {600, 12},
        {601, 483},
        {602, 1'888},
        {603, 2'471},
        {604, 1'528},
        {605, 453},
        {606, 268},
        {607, 209},
        {608, 118},
        {609, 20},
        {610, 4},
        {613, 2},
        {614, 8},
        {617, 4},
        {618, 93},
        {619, 6},
        {620, 12},
        {621, 8},
        {622, 10},
        {623, 10},
        {625, 4},
        {626, 4},
        {627, 56},
        {628, 29'706},
        {629, 29},
        {630, 4},
        {631, 4},
        {632, 2},
        {636, 4},
        {638, 2},
        {639, 14},
        {640, 52},
        {641, 86},
        {642, 90},
        {643, 32},
        {644, 21},
        {645, 24},
        {646, 34},
        {647, 24},
        {648, 2},
        {650, 2},
        {651, 4},
        {652, 6},
        {653, 4},
        {654, 2},
        {655, 44},
        {656, 2},
        {657, 5},
        {658, 1},
        {659, 1},
        {660, 4},
        {661, 50},
        {662, 62},
        {663, 34},
        {667, 6},
        {672, 4},
        {673, 18},
        {674, 12},
        {675, 46},
        {676, 42},
        {677, 22},
        {678, 12},
        {679, 4},
        {680, 6},
        {685, 2},
        {686, 8},
        {687, 6},
        {688, 2},
        {689, 4},
        {690, 2},
        {691, 4},
        {692, 6},
        {693, 10},
        {694, 8},
        {695, 2},
        {697, 8},
        {698, 14},
        {699, 17},
        {700, 34},
        {701, 22},
        {702, 14},
        {703, 14},
        {704, 6},
        {705, 4},
        {708, 6},
        {709, 6},
        {710, 16},
        {711, 13},
        {712, 6},
        {714, 4},
        {715, 2},
        {717, 2},
        {718, 2},
        {719, 2},
        {721, 4},
        {724, 4},
        {725, 2},
        {727, 2},
        {728, 2},
        {730, 4},
        {731, 2},
        {733, 10},
        {734, 12},
        {735, 22},
        {736, 4},
        {739, 2},
        {740, 2},
        {741, 2},
        {743, 4},
        {745, 2},
        {746, 4},
        {747, 8},
        {748, 8},
        {749, 14},
        {750, 20},
        {751, 35},
        {752, 43},
        {753, 28},
        {754, 10},
        {755, 8},
        {756, 27},
        {757, 101},
        {758, 371},
        {759, 503},
        {760, 351},
        {761, 127},
        {762, 10},
        {763, 10},
        {764, 4},
        {765, 4},
        {766, 4},
        {767, 4},
        {768, 6},
        {769, 4},
        {771, 2},
        {772, 2},
        {773, 2},
        {774, 6},
        {779, 2},
        {781, 6},
        {782, 4},
        {783, 2},
        {785, 2},
        {787, 2},
        {789, 4},
        {792, 2},
        {794, 4},
        {796, 2},
        {797, 4},
        {802, 8},
        {804, 2},
        {805, 2},
        {807, 26},
        {808, 6},
        {811, 2},
        {812, 2},
        {813, 4},
        {814, 6},
        {815, 4},
        {816, 20},
        {817, 14},
        {818, 4},
        {819, 10},
        {820, 8},
        {821, 2},
        {823, 4},
        {825, 2},
        {826, 2},
        {827, 2},
        {829, 2},
        {830, 8},
        {831, 7},
        {832, 6},
        {833, 6},
        {834, 2},
        {835, 2},
        {836, 2},
        {838, 4},
        {841, 2},
        {843, 4},
        {847, 8},
        {852, 2},
        {853, 2},
        {854, 2},
        {855, 4},
        {856, 14},
        {857, 28},
        {858, 64},
        {859, 83},
        {860, 60},
        {861, 33},
        {862, 16},
        {863, 4},
        {865, 2},
        {866, 2},
        {867, 4},
        {871, 2},
        {874, 2},
        {875, 4},
        {876, 2},
        {877, 2},
        {878, 2},
        {879, 2},
        {880, 6},
        {881, 18},
        {882, 56},
        {883, 144},
        {884, 182},
        {885, 131},
        {886, 42},
        {887, 4},
        {889, 2},
        {893, 4},
        {895, 6},
        {896, 2},
        {900, 2},
        {902, 2},
        {905, 4},
        {906, 2},
        {907, 2},
        {916, 6},
        {917, 4},
        {922, 4},
        {923, 2},
        {924, 4},
        {926, 6},
        {928, 2},
        {929, 2},
        {935, 4},
        {942, 4},
        {943, 2},
        {945, 2},
        {946, 2},
        {947, 2},
        {952, 8},
        {953, 2},
        {954, 2},
        {960, 2},
        {961, 2},
        {962, 6},
        {963, 8},
        {964, 20},
        {965, 30},
        {966, 22},
        {967, 18},
        {968, 6},
        {969, 4},
        {970, 2},
        {974, 4},
        {975, 6},
        {976, 10},
        {977, 17},
        {978, 10},
        {979, 10},
        {980, 8},
        {981, 8},
        {982, 2},
        {983, 2},
        {987, 4},
        {991, 4},
        {993, 2},
        {995, 6},
        {996, 12},
        {997, 24},
        {999, 2},
        {1000, 6},
        {1001, 4},
        {1005, 4},
        {1006, 2},
        {1007, 2},
        {1009, 2},
        {1010, 14},
        {1011, 10},
        {1012, 2},
        {1013, 2},
        {1016, 4},
        {1017, 2},
        {1018, 2},
        {1020, 4},
        {1022, 2},
        {1023, 2},
        {1025, 4},
        {1026, 2},
        {1027, 2},
        {1033, 2},
        {1034, 4},
        {1035, 4},
        {1036, 2},
        {1037, 2},
        {1038, 2},
        {1039, 12},
        {1041, 8},
        {1042, 2},
        {1043, 4},
        {1044, 4},
        {1045, 6},
        {1046, 6},
        {1047, 6},
        {1048, 4},
        {1049, 2},
        {1050, 8},
        {1051, 6},
        {1052, 10},
        {1053, 8},
        {1054, 6},
        {1055, 18},
        {1056, 10},
        {1057, 14},
        {1058, 6},
        {1059, 16},
        {1060, 4},
        {1061, 20},
        {1062, 12},
        {1063, 16},
        {1064, 14},
        {1065, 14},
        {1066, 24},
        {1067, 10},
        {1068, 16},
        {1069, 23},
        {1070, 22},
        {1071, 18},
        {1072, 39},
        {1073, 31},
        {1074, 44},
        {1075, 56},
        {1076, 46},
        {1077, 78},
        {1078, 54},
        {1079, 52},
        {1080, 44},
        {1081, 26},
        {1082, 12},
        {1083, 26},
        {1084, 24},
        {1085, 22},
        {1086, 20},
        {1087, 16},
        {1088, 32},
        {1089, 40},
        {1090, 24},
        {1091, 26},
        {1092, 64},
        {1093, 58},
        {1094, 36},
        {1095, 61},
        {1096, 50},
        {1097, 75},
        {1098, 56},
        {1099, 60},
        {1100, 40},
        {1101, 60},
        {1102, 38},
        {1103, 34},
        {1104, 48},
        {1105, 40},
        {1106, 48},
        {1107, 34},
        {1108, 30},
        {1109, 32},
        {1110, 40},
        {1111, 48},
        {1112, 36},
        {1113, 30},
        {1114, 48},
        {1115, 34},
        {1116, 44},
        {1117, 32},
        {1118, 60},
        {1119, 44},
        {1120, 66},
        {1121, 36},
        {1122, 56},
        {1123, 44},
        {1124, 52},
        {1125, 32},
        {1126, 60},
        {1127, 25},
        {1128, 48},
        {1129, 40},
        {1130, 40},
        {1131, 38},
        {1132, 52},
        {1133, 30},
        {1134, 44},
        {1135, 36},
        {1136, 54},
        {1137, 52},
        {1138, 46},
        {1139, 50},
        {1140, 40},
        {1141, 42},
        {1142, 52},
        {1143, 30},
        {1144, 36},
        {1145, 36},
        {1146, 42},
        {1147, 52},
        {1148, 50},
        {1149, 44},
        {1150, 44},
        {1151, 38},
        {1152, 50},
        {1153, 44},
        {1154, 44},
        {1155, 48},
        {1156, 34},
        {1157, 66},
        {1158, 60},
        {1159, 36},
        {1160, 46},
        {1161, 36},
        {1162, 62},
        {1163, 40},
        {1164, 40},
        {1165, 46},
        {1166, 38},
        {1167, 28},
        {1168, 48},
        {1169, 48},
        {1170, 43},
        {1171, 44},
        {1172, 32},
        {1173, 44},
        {1174, 38},
        {1175, 36},
        {1176, 38},
        {1177, 30},
        {1178, 40},
        {1179, 46},
        {1180, 46},
        {1181, 26},
        {1182, 40},
        {1183, 26},
        {1184, 32},
        {1185, 32},
        {1186, 28},
        {1187, 42},
        {1188, 28},
        {1189, 20},
        {1190, 24},
        {1191, 12},
        {1192, 28},
        {1193, 12},
        {1194, 16},
        {1195, 16},
        {1196, 24},
        {1197, 26},
        {1198, 12},
        {1199, 18},
        {1200, 12},
        {1201, 58},
        {1202, 58},
        {1203, 6},
        {1204, 6},
        {1205, 2},
        {1206, 2},
        {1207, 2},
        {1208, 4},
        {1209, 2},
        {1210, 12},
        {1212, 2},
        {1213, 6},
        {1214, 6},
        {1217, 2},
        {1218, 4},
        {1219, 2},
        {1220, 4},
        {1221, 6},
        {1222, 2},
        {1224, 6},
        {1225, 6},
        {1227, 8},
        {1228, 10},
        {1229, 14},
        {1230, 4},
        {1231, 4},
        {1232, 4},
        {1233, 4},
        {1234, 2},
        {1236, 6},
        {1237, 8},
        {1238, 8},
        {1239, 8},
        {1240, 2},
        {1241, 12},
        {1242, 14},
        {1243, 2},
        {1244, 8},
        {1245, 4},
        {1246, 8},
        {1247, 4},
        {1248, 8},
        {1249, 12},
        {1250, 6},
        {1251, 6},
        {1252, 6},
        {1253, 8},
        {1254, 2},
        {1257, 2},
        {1258, 12},
        {1259, 14},
        {1260, 4},
        {1261, 6},
        {1262, 8},
        {1263, 4},
        {1264, 6},
        {1265, 10},
        {1266, 8},
        {1267, 4},
        {1268, 14},
        {1269, 2},
        {1270, 10},
        {1271, 10},
        {1272, 16},
        {1273, 8},
        {1274, 8},
        {1275, 8},
        {1276, 2},
        {1277, 2},
        {1278, 2},
        {1279, 10},
        {1280, 4},
        {1281, 4},
        {1282, 6},
        {1283, 8},
        {1284, 10},
        {1285, 16},
        {1286, 6},
        {1287, 8},
        {1288, 4},
        {1289, 10},
        {1290, 10},
        {1291, 6},
        {1292, 6},
        {1293, 2},
        {1294, 8},
        {1295, 8},
        {1296, 8},
        {1297, 10},
        {1298, 4},
        {1299, 10},
        {1300, 8},
        {1301, 48},
        {1302, 8},
        {1303, 10},
        {1304, 12},
        {1305, 8},
        {1306, 10},
        {1307, 2},
        {1308, 6},
        {1309, 30},
        {1310, 6},
        {1311, 26},
        {1312, 70},
        {1313, 109},
        {1314, 140},
        {1315, 161},
        {1316, 86},
        {1317, 53},
        {1318, 30},
        {1319, 12},
        {1320, 22},
        {1321, 12},
        {1322, 2},
        {1323, 20},
        {1324, 6},
        {1325, 27},
        {1326, 10},
        {1327, 6},
        {1328, 10},
        {1329, 6},
        {1330, 10},
        {1331, 11},
        {1332, 4},
        {1333, 18},
        {1334, 6},
        {1335, 12},
        {1336, 10},
        {1337, 6},
        {1338, 10},
        {1339, 6},
        {1340, 18},
        {1341, 8},
        {1342, 16},
        {1343, 2},
        {1344, 6},
        {1345, 10},
        {1346, 12},
        {1347, 6},
        {1348, 4},
        {1349, 10},
        {1350, 14},
        {1351, 8},
        {1352, 4},
        {1353, 12},
        {1354, 8},
        {1355, 6},
        {1356, 8},
        {1357, 16},
        {1358, 6},
        {1359, 6},
        {1360, 8},
        {1361, 12},
        {1362, 14},
        {1363, 10},
        {1364, 6},
        {1365, 12},
        {1366, 6},
        {1367, 6},
        {1368, 4},
        {1369, 8},
        {1370, 14},
        {1371, 14},
        {1372, 10},
        {1373, 12},
        {1374, 14},
        {1375, 4},
        {1376, 12},
        {1377, 6},
        {1378, 16},
        {1379, 14},
        {1380, 12},
        {1381, 16},
        {1382, 16},
        {1383, 8},
        {1384, 8},
        {1385, 10},
        {1386, 10},
        {1387, 20},
        {1388, 21},
        {1389, 18},
        {1390, 21},
        {1391, 14},
        {1392, 22},
        {1393, 10},
        {1394, 4},
        {1395, 18},
        {1396, 16},
        {1397, 16},
        {1398, 14},
        {1399, 18},
        {1400, 8},
        {1401, 12},
        {1402, 2},
        {1403, 14},
        {1404, 10},
        {1405, 22},
        {1406, 12},
        {1407, 4},
        {1408, 12},
        {1409, 16},
        {1410, 10},
        {1411, 16},
        {1412, 26},
        {1413, 22},
        {1414, 18},
        {1415, 8},
        {1416, 10},
        {1417, 10},
        {1418, 26},
        {1419, 10},
        {1420, 18},
        {1421, 14},
        {1422, 12},
        {1423, 16},
        {1424, 18},
        {1425, 6},
        {1426, 8},
        {1427, 14},
        {1428, 16},
        {1429, 24},
        {1430, 16},
        {1431, 28},
        {1432, 18},
        {1433, 12},
        {1434, 20},
        {1435, 24},
        {1436, 20},
        {1437, 14},
        {1438, 10},
        {1439, 30},
        {1440, 20},
        {1441, 22},
        {1442, 30},
        {1443, 12},
        {1444, 16},
        {1445, 14},
        {1446, 26},
        {1447, 12},
        {1448, 18},
        {1449, 24},
        {1450, 28},
        {1451, 18},
        {1452, 20},
        {1453, 20},
        {1454, 28},
        {1455, 34},
        {1456, 30},
        {1457, 20},
        {1458, 18},
        {1459, 24},
        {1460, 12},
        {1461, 32},
        {1462, 23},
        {1463, 16},
        {1464, 20},
        {1465, 26},
        {1466, 34},
        {1467, 16},
        {1468, 20},
        {1469, 20},
        {1470, 28},
        {1471, 20},
        {1472, 14},
        {1473, 12},
        {1474, 42},
        {1475, 12},
        {1476, 92},
        {1477, 92},
        {1478, 22},
        {1479, 28},
        {1480, 30},
        {1481, 96},
        {1482, 68},
        {1483, 22},
        {1484, 36},
        {1485, 20},
        {1486, 34},
        {1487, 30},
        {1488, 48},
        {1489, 36},
        {1490, 28},
        {1491, 40},
        {1492, 32},
        {1493, 28},
        {1494, 88},
        {1495, 100},
        {1496, 28},
        {1497, 36},
        {1498, 32},
        {1499, 24},
        {1500, 38},
        {1501, 18},
        {1502, 26},
        {1503, 16},
        {1504, 42},
        {1505, 40},
        {1506, 38},
        {1507, 22},
        {1508, 22},
        {1509, 32},
        {1510, 46},
        {1511, 30},
        {1512, 32},
        {1513, 32},
        {1514, 52},
        {1515, 44},
        {1516, 26},
        {1517, 34},
        {1518, 46},
        {1519, 38},
        {1520, 42},
        {1521, 42},
        {1522, 52},
        {1523, 46},
        {1524, 32},
        {1525, 28},
        {1526, 50},
        {1527, 40},
        {1528, 18},
        {1529, 36},
        {1530, 38},
        {1531, 44},
        {1532, 30},
        {1533, 32},
        {1534, 86},
        {1535, 88},
        {1536, 52},
        {1537, 52},
        {1538, 34},
        {1539, 42},
        {1540, 78},
        {1541, 118},
        {1542, 40},
        {1543, 38},
        {1544, 44},
        {1545, 60},
        {1546, 22},
        {1547, 54},
        {1548, 56},
        {1549, 38},
        {1550, 40},
        {1551, 72},
        {1552, 42},
        {1553, 44},
        {1554, 42},
        {1555, 48},
        {1556, 58},
        {1557, 46},
        {1558, 52},
        {1559, 64},
        {1560, 50},
        {1561, 38},
        {1562, 58},
        {1563, 64},
        {1564, 26},
        {1565, 60},
        {1566, 48},
        {1567, 62},
        {1568, 62},
        {1569, 60},
        {1570, 42},
        {1571, 54},
        {1572, 28},
        {1573, 28},
        {1599, 2},
        {1600, 8},
        {1601, 4},
        {1602, 29},
        {1603, 34},
        {1604, 28},
        {1605, 32},
        {1606, 27},
        {1607, 18},
        {1608, 12},
        {1612, 2},
        {1623, 22},
        {1624, 22},
        {1639, 94},
        {1649, 24},
        {1650, 22},
        {2983, 2},
        {3054, 14},
        {4026, 6},
        {4032, 3},
        {4096, 22},
        {7079, 2},
        {7150, 13},
        {9319, 3},
    };

    const auto max_count{static_cast<double>(raw_histogram.begin()->second)}; // 1 byte is the most common
    const auto SCALING_FACTOR{100'000U};

    FastRandomContext rng{/*fDeterministic=*/true};
    std::vector<std::vector<std::byte>> test_data;
    test_data.reserve(20 * raw_histogram.size());
    size_t total_bytes{0};
    for (const auto& [size, count] : raw_histogram) {
        const size_t scaled_count{static_cast<size_t>(std::ceil((static_cast<double>(count) / max_count) * SCALING_FACTOR))};
        total_bytes += scaled_count * size;
        for (size_t i{0}; i < scaled_count; ++i) {
            test_data.push_back(rng.randbytes<std::byte>(size));
        }
    }
    std::shuffle(test_data.begin(), test_data.end(), rng); // Make it more realistic & less predictable
    assert(total_bytes == 4'067'165);

    std::vector key_bytes{rng.randbytes<std::byte>(8)};
    uint64_t key;
    std::memcpy(&key, key_bytes.data(), 8);

    bench.batch(total_bytes).unit("byte").run([&] {
        for (size_t offset = 0; offset < 10; ++offset) {
            for (auto& data : test_data) {
                util::Xor(data, key, offset);
            }
        }
        ankerl::nanobench::doNotOptimizeAway(test_data);
    });
}

static void AutoFileXor(benchmark::Bench& bench)
{
    FastRandomContext rng{/*fDeterministic=*/true};
    auto data{rng.randbytes<std::byte>(4'000'000)};

    std::vector<std::byte> empty_key_bytes(8, std::byte{0}); // Test disabled xor
    uint64_t empty_key;
    std::memcpy(&empty_key, empty_key_bytes.data(), 8);

    const fs::path test_path = fs::temp_directory_path() / "xor_benchmark.dat";
    AutoFile f{fsbridge::fopen(test_path, "wb+"), empty_key};
    bench.batch(data.size()).unit("byte").run([&] {
        f.Truncate(0);
        f << data;
    });
    try { fs::remove(test_path); } catch (const fs::filesystem_error&) {}
}

BENCHMARK(XorHistogram, benchmark::PriorityLevel::HIGH);
BENCHMARK(AutoFileXor, benchmark::PriorityLevel::LOW);
