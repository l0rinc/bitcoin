// Copyright (c) The Bitcoin Core developers
// Distributed under the MIT software license, see the accompanying
// file COPYING or https://opensource.org/license/mit/.

#include <bench/bench.h>
#include <random.h>
#include <span.h>
#include <streams.h>

#include <cmath>
#include <cstddef>
#include <map>
#include <vector>

static void XorHistogram(benchmark::Bench& bench)
{
    // The top util::Xor method's [write.size(), frequency] calls for the IBD of the first 860k blocks
    std::map<uint32_t, uint64_t> histogram{
        std::pair{1, 47584838861},
        std::pair{2, 155252857},
        std::pair{4, 14983070199},
        std::pair{7, 51354839},
        std::pair{8, 5939128629},
        std::pair{9, 16698793},
        std::pair{10, 27406144},
        std::pair{11, 3986792},
        std::pair{12, 3282613},
        std::pair{13, 314839},
        std::pair{14, 536980},
        std::pair{15, 1610643},
        std::pair{16, 542064},
        std::pair{17, 407345},
        std::pair{18, 261587},
        std::pair{19, 230151},
        std::pair{20, 339705},
        std::pair{21, 2019807250},
        std::pair{22, 1616301504},
        std::pair{23, 2357347372},
        std::pair{25, 2705183236},
        std::pair{26, 35870265},
        std::pair{27, 87057844},
        std::pair{28, 78184146},
        std::pair{29, 30858682},
        std::pair{30, 19197417},
        std::pair{31, 1579479},
        std::pair{32, 5369404406},
        std::pair{33, 2025696499},
        std::pair{34, 682781008},
        std::pair{35, 269339238},
        std::pair{36, 223445},
        std::pair{37, 41467794},
        std::pair{38, 1475762},
        std::pair{39, 6662400},
        std::pair{40, 50600412},
        std::pair{41, 5297315},
        std::pair{42, 3013707},
        std::pair{43, 443306},
        std::pair{44, 567194},
        std::pair{46, 111535},
        std::pair{47, 155071},
        std::pair{48, 1038788},
        std::pair{49, 101166},
        std::pair{53, 414677},
        std::pair{54, 42084},
        std::pair{55, 150863},
        std::pair{56, 694439},
        std::pair{58, 38884},
        std::pair{59, 69597},
        std::pair{60, 55155},
        std::pair{62, 64150},
        std::pair{63, 44837},
        std::pair{64, 275253628},
        std::pair{65, 29197009},
        std::pair{66, 463395},
        std::pair{67, 1807929},
        std::pair{68, 264550},
        std::pair{69, 1031048},
        std::pair{70, 12772097},
        std::pair{71, 1763349816},
        std::pair{72, 827712501},
        std::pair{73, 3835426},
        std::pair{74, 869472},
        std::pair{75, 538515},
        std::pair{76, 268232},
        std::pair{77, 1407359},
        std::pair{78, 2899481},
        std::pair{79, 672145},
        std::pair{80, 2240943},
        std::pair{81, 1142405},
        std::pair{82, 482636},
        std::pair{83, 53818260},
        std::pair{84, 551826},
        std::pair{85, 274521},
        std::pair{86, 191212},
        std::pair{87, 148744},
        std::pair{88, 798839},
        std::pair{89, 131754},
        std::pair{90, 181244},
        std::pair{91, 632574},
        std::pair{92, 54802},
        std::pair{93, 40008},
        std::pair{94, 58679},
        std::pair{95, 3986219},
        std::pair{96, 69872},
        std::pair{97, 836318},
        std::pair{98, 124792},
        std::pair{99, 228622},
        std::pair{100, 550755},
        std::pair{101, 70480},
        std::pair{102, 29036},
        std::pair{103, 134544},
        std::pair{104, 138387},
        std::pair{105, 198656556},
        std::pair{106, 1193555153},
        std::pair{107, 1064027363},
        std::pair{108, 24662023},
        std::pair{109, 7506161},
        std::pair{110, 1500218},
        std::pair{111, 2768082},
        std::pair{112, 3056669},
        std::pair{113, 17829712},
        std::pair{114, 9826401},
        std::pair{115, 409391},
        std::pair{116, 388988},
        std::pair{117, 199627},
        std::pair{118, 156933},
        std::pair{119, 266888},
        std::pair{120, 2215468},
        std::pair{121, 3735124},
        std::pair{122, 3221526},
        std::pair{123, 12986923},
        std::pair{124, 3039553},
        std::pair{125, 2378723},
        std::pair{126, 4080425},
        std::pair{127, 3993712},
        std::pair{128, 13323530},
        std::pair{129, 1404783},
        std::pair{130, 7111451},
        std::pair{131, 6398914},
        std::pair{132, 1574554},
        std::pair{133, 753121},
        std::pair{134, 995846},
        std::pair{135, 2299257},
        std::pair{136, 2841133},
        std::pair{137, 1432824},
        std::pair{138, 112918349},
        std::pair{139, 155158814},
        std::pair{140, 37826769},
        std::pair{141, 138259},
        std::pair{142, 228782},
        std::pair{143, 155226},
        std::pair{144, 523085},
        std::pair{145, 1043545},
        std::pair{146, 936776},
        std::pair{147, 135958},
        std::pair{148, 53477},
        std::pair{149, 85944},
        std::pair{150, 139591},
        std::pair{151, 51432},
        std::pair{152, 101719},
        std::pair{153, 71302},
        std::pair{154, 26873},
        std::pair{155, 150196},
        std::pair{156, 44863},
        std::pair{157, 81708},
        std::pair{158, 16245},
        std::pair{159, 16539},
        std::pair{160, 30363},
        std::pair{161, 19167},
        std::pair{163, 59580},
        std::pair{164, 247459},
        std::pair{165, 248525},
        std::pair{166, 56551},
        std::pair{167, 72096},
        std::pair{169, 80727},
        std::pair{170, 83764},
        std::pair{172, 42020},
        std::pair{173, 482585},
        std::pair{174, 63200},
        std::pair{175, 23018},
        std::pair{176, 29041},
        std::pair{177, 27504},
        std::pair{178, 162526},
        std::pair{179, 16034},
        std::pair{180, 54624},
        std::pair{181, 54459},
        std::pair{184, 24405},
        std::pair{186, 23024},
        std::pair{187, 156538},
        std::pair{188, 31919},
        std::pair{189, 53778},
        std::pair{190, 95945},
        std::pair{191, 91777},
        std::pair{192, 756282},
        std::pair{193, 130194},
        std::pair{194, 14765},
        std::pair{195, 19600},
        std::pair{196, 35530},
        std::pair{197, 18439},
        std::pair{198, 645343},
        std::pair{199, 49680},
        std::pair{200, 110974},
        std::pair{201, 192016},
        std::pair{202, 77989},
        std::pair{203, 97997},
        std::pair{204, 122473},
        std::pair{205, 197169},
        std::pair{206, 666763},
        std::pair{207, 125972},
        std::pair{208, 44187},
        std::pair{209, 63692},
        std::pair{210, 180094},
        std::pair{211, 78496},
        std::pair{212, 76417},
        std::pair{213, 48926},
        std::pair{214, 114383},
        std::pair{215, 82850},
        std::pair{216, 262811},
        std::pair{217, 13625647},
        std::pair{218, 25918921},
        std::pair{219, 12992432},
        std::pair{220, 108554},
        std::pair{221, 31243},
        std::pair{222, 29187},
        std::pair{223, 10083},
        std::pair{224, 22281},
        std::pair{225, 13950},
        std::pair{226, 31886},
        std::pair{227, 18084},
        std::pair{228, 14657},
        std::pair{229, 79168},
        std::pair{230, 15963},
        std::pair{231, 21742},
        std::pair{232, 11410},
        std::pair{233, 12367},
        std::pair{234, 15037},
        std::pair{235, 16192},
        std::pair{236, 25139},
        std::pair{237, 16192},
        std::pair{238, 18500},
        std::pair{239, 18810},
        std::pair{240, 38316},
        std::pair{241, 149042},
        std::pair{242, 24003},
        std::pair{243, 19104},
        std::pair{244, 15440},
        std::pair{245, 9379},
        std::pair{247, 9889},
        std::pair{248, 12683},
        std::pair{249, 85955},
        std::pair{250, 48511},
        std::pair{251, 746625},
        std::pair{252, 48105681},
        std::pair{253, 83729340},
        std::pair{254, 38940977},
        std::pair{255, 151929},
        std::pair{256, 28326},
        std::pair{257, 47575},
        std::pair{258, 25005},
        std::pair{259, 24940},
        std::pair{260, 37845},
        std::pair{261, 23197},
        std::pair{262, 34312},
        std::pair{263, 21453},
        std::pair{264, 55215},
        std::pair{267, 11005},
        std::pair{268, 40335},
        std::pair{269, 31338},
        std::pair{275, 8153},
        std::pair{278, 12014},
        std::pair{280, 19109},
        std::pair{282, 17085},
        std::pair{283, 27004},
        std::pair{284, 346378},
        std::pair{285, 342589},
        std::pair{286, 352838},
        std::pair{287, 343470},
        std::pair{288, 242657},
        std::pair{289, 13735},
        std::pair{290, 23228},
        std::pair{291, 22868},
        std::pair{296, 10044},
        std::pair{297, 67198},
        std::pair{298, 21992},
        std::pair{299, 28253},
        std::pair{302, 23977},
        std::pair{306, 17984},
        std::pair{307, 11476},
        std::pair{308, 7421},
        std::pair{309, 8469},
        std::pair{314, 11850},
        std::pair{315, 16052},
        std::pair{316, 25342},
        std::pair{317, 28064},
        std::pair{318, 20989},
        std::pair{319, 23071},
        std::pair{320, 48109},
        std::pair{321, 48075},
        std::pair{322, 25238},
        std::pair{323, 10398},
        std::pair{324, 37202},
        std::pair{325, 51911},
        std::pair{326, 39506},
        std::pair{327, 11413},
        std::pair{333, 13024},
        std::pair{334, 19214},
        std::pair{335, 28438},
        std::pair{337, 8269},
        std::pair{342, 13666},
        std::pair{344, 6944},
        std::pair{345, 7907},
        std::pair{347, 16630},
        std::pair{348, 593985},
        std::pair{349, 1130760},
        std::pair{350, 578492},
        std::pair{351, 14457},
        std::pair{352, 7764},
        std::pair{353, 9544},
        std::pair{354, 263313},
        std::pair{355, 513902},
        std::pair{356, 260735},
        std::pair{358, 36433},
        std::pair{359, 75013},
        std::pair{360, 78454},
        std::pair{361, 35048},
        std::pair{362, 9077},
        std::pair{363, 7329},
        std::pair{365, 6250},
        std::pair{366, 38768},
        std::pair{368, 6462},
        std::pair{370, 6695},
        std::pair{371, 6738},
        std::pair{372, 6741},
        std::pair{373, 6718},
        std::pair{374, 22779},
        std::pair{377, 15183},
        std::pair{378, 8535},
        std::pair{381, 9493},
        std::pair{383, 8045},
        std::pair{386, 9833},
        std::pair{388, 6020},
        std::pair{389, 6431},
        std::pair{390, 6042},
        std::pair{391, 12471},
        std::pair{392, 288555},
        std::pair{393, 805000},
        std::pair{394, 798675},
        std::pair{395, 268494},
        std::pair{402, 5731},
        std::pair{403, 8028},
        std::pair{404, 8535},
        std::pair{406, 5719},
        std::pair{408, 13451},
        std::pair{410, 7235},
        std::pair{412, 5798},
        std::pair{415, 9227},
        std::pair{416, 7012},
        std::pair{417, 6305},
        std::pair{418, 16208},
        std::pair{419, 5801},
        std::pair{422, 6460},
        std::pair{423, 14468},
        std::pair{424, 31198},
        std::pair{425, 6148},
        std::pair{426, 22403},
        std::pair{427, 30448},
        std::pair{428, 32413},
        std::pair{429, 14787},
        std::pair{430, 7622},
        std::pair{431, 5669},
        std::pair{432, 19538},
        std::pair{437, 9812},
        std::pair{438, 5234},
        std::pair{439, 5277},
        std::pair{440, 24196},
        std::pair{441, 5915},
        std::pair{442, 5495},
        std::pair{443, 5093},
        std::pair{444, 5122},
        std::pair{445, 7284},
        std::pair{452, 6373},
        std::pair{454, 14438},
        std::pair{458, 5345},
        std::pair{459, 9986},
        std::pair{460, 25818},
        std::pair{461, 46493},
        std::pair{462, 42770},
        std::pair{463, 15676},
        std::pair{464, 7848},
        std::pair{465, 10933},
        std::pair{466, 25088},
        std::pair{467, 8687},
        std::pair{468, 5129},
        std::pair{476, 6189},
        std::pair{478, 4757},
        std::pair{479, 4846},
        std::pair{480, 11673},
        std::pair{481, 7191},
        std::pair{482, 7809},
        std::pair{483, 6500},
        std::pair{484, 29549},
        std::pair{485, 5616},
        std::pair{486, 81135},
        std::pair{487, 1836899},
        std::pair{488, 4909014},
        std::pair{489, 4483016},
        std::pair{490, 1380253},
        std::pair{491, 6215},
        std::pair{492, 5690},
        std::pair{493, 6055},
        std::pair{494, 6152},
        std::pair{495, 7111},
        std::pair{496, 9440},
        std::pair{497, 8856},
        std::pair{498, 16635},
        std::pair{499, 23648},
        std::pair{500, 34100},
        std::pair{501, 28017},
        std::pair{502, 11328},
        std::pair{503, 6404},
        std::pair{504, 6609},
        std::pair{505, 5843},
        std::pair{506, 8391},
        std::pair{507, 6715},
        std::pair{508, 7718},
        std::pair{509, 7176},
        std::pair{510, 7907},
        std::pair{511, 7416},
        std::pair{512, 7470},
        std::pair{513, 8519},
        std::pair{514, 7539},
        std::pair{515, 8152},
        std::pair{516, 18214},
        std::pair{517, 7683},
        std::pair{518, 12525},
        std::pair{519, 8026},
        std::pair{520, 13074},
        std::pair{521, 9877},
        std::pair{522, 9724},
        std::pair{523, 8772},
        std::pair{524, 8703},
        std::pair{525, 8371},
        std::pair{526, 8736},
        std::pair{527, 14001},
        std::pair{528, 22842},
        std::pair{529, 8367},
        std::pair{530, 9047},
        std::pair{531, 9902},
        std::pair{532, 9660},
        std::pair{533, 10733},
        std::pair{534, 12872},
        std::pair{535, 11037},
        std::pair{536, 10538},
        std::pair{537, 9862},
        std::pair{538, 7955},
        std::pair{539, 6772},
        std::pair{540, 6423},
        std::pair{541, 7553},
        std::pair{542, 8321},
        std::pair{543, 8603},
        std::pair{544, 17988},
        std::pair{545, 6705},
        std::pair{546, 5722},
        std::pair{547, 6070},
        std::pair{548, 6433},
        std::pair{549, 5086},
        std::pair{550, 4713},
        std::pair{551, 4981},
        std::pair{552, 4844},
        std::pair{553, 7459},
        std::pair{554, 20596},
        std::pair{555, 15940},
        std::pair{556, 9479},
        std::pair{557, 5917},
        std::pair{558, 6102},
        std::pair{559, 5010},
        std::pair{560, 5632},
        std::pair{561, 8368},
        std::pair{562, 6829},
        std::pair{563, 5066},
        std::pair{564, 22671},
        std::pair{565, 8881},
        std::pair{566, 16467},
        std::pair{567, 11634},
        std::pair{568, 7651},
        std::pair{569, 5176},
        std::pair{570, 5142},
        std::pair{571, 5646},
        std::pair{572, 5332},
        std::pair{573, 5034},
        std::pair{574, 5830},
        std::pair{575, 6663},
        std::pair{576, 8678},
        std::pair{577, 11161},
        std::pair{578, 7151},
        std::pair{579, 5771},
        std::pair{580, 5632},
        std::pair{581, 4045},
        std::pair{594, 9095},
        std::pair{595, 10823},
        std::pair{596, 4297},
        std::pair{598, 3772},
        std::pair{599, 5252},
        std::pair{600, 3817},
        std::pair{602, 6147},
        std::pair{603, 7215},
        std::pair{604, 5307},
        std::pair{605, 3906},
        std::pair{606, 4662},
        std::pair{607, 13020},
        std::pair{610, 12640},
        std::pair{613, 5599},
        std::pair{615, 11544},
        std::pair{617, 3953},
        std::pair{619, 4334},
        std::pair{625, 6609},
        std::pair{626, 47564},
        std::pair{628, 69105},
        std::pair{632, 6420},
        std::pair{636, 3551},
        std::pair{641, 8516},
        std::pair{644, 3553},
        std::pair{645, 3661},
        std::pair{646, 3985},
        std::pair{647, 4859},
        std::pair{649, 4228},
        std::pair{651, 4285},
        std::pair{653, 3644},
        std::pair{661, 4369},
        std::pair{662, 5890},
        std::pair{663, 6778},
        std::pair{664, 10663},
        std::pair{670, 4289},
        std::pair{671, 4389},
        std::pair{672, 4262},
        std::pair{673, 3708},
        std::pair{674, 5386},
        std::pair{683, 8732},
        std::pair{686, 3687},
        std::pair{687, 5581},
        std::pair{688, 5593},
        std::pair{689, 4053},
        std::pair{692, 3318},
        std::pair{693, 3518},
        std::pair{694, 4205},
        std::pair{695, 4752},
        std::pair{696, 5331},
        std::pair{697, 5591},
        std::pair{698, 5968},
        std::pair{699, 5988},
        std::pair{700, 5381},
        std::pair{701, 4386},
        std::pair{702, 4465},
        std::pair{703, 3793},
        std::pair{704, 4394},
        std::pair{705, 3636},
        std::pair{707, 3691},
        std::pair{709, 3288},
        std::pair{711, 22844},
        std::pair{714, 3148},
        std::pair{717, 3239},
        std::pair{718, 4170},
        std::pair{719, 4739},
        std::pair{720, 3560},
        std::pair{721, 4730},
        std::pair{722, 4524},
        std::pair{724, 3741},
        std::pair{725, 10294},
        std::pair{729, 4879},
        std::pair{730, 8636},
        std::pair{732, 3064},
        std::pair{734, 23400},
        std::pair{736, 3542},
        std::pair{737, 3331},
        std::pair{738, 3238},
        std::pair{740, 3083},
        std::pair{741, 3032},
        std::pair{742, 4008},
        std::pair{744, 3277},
        std::pair{745, 3162},
        std::pair{746, 3178},
        std::pair{748, 3393},
        std::pair{749, 3352},
        std::pair{750, 3341},
        std::pair{751, 3716},
        std::pair{752, 4696},
        std::pair{753, 3265},
        std::pair{754, 3621},
        std::pair{755, 3734},
        std::pair{756, 3824},
        std::pair{757, 3535},
        std::pair{758, 4118},
        std::pair{759, 5714},
        std::pair{760, 4043},
        std::pair{761, 4628},
        std::pair{762, 3808},
        std::pair{763, 3684},
        std::pair{764, 3989},
        std::pair{765, 3638},
        std::pair{766, 4037},
        std::pair{767, 4227},
        std::pair{768, 3933},
        std::pair{769, 4183},
        std::pair{770, 5118},
        std::pair{771, 4493},
        std::pair{772, 4038},
        std::pair{773, 3737},
        std::pair{774, 3924},
        std::pair{775, 3603},
        std::pair{776, 3906},
        std::pair{777, 3614},
        std::pair{778, 3869},
        std::pair{779, 23482},
        std::pair{780, 3934},
        std::pair{781, 3869},
        std::pair{782, 3967},
        std::pair{783, 3762},
        std::pair{784, 8108},
        std::pair{785, 3788},
        std::pair{786, 3710},
        std::pair{787, 3368},
        std::pair{788, 4644},
        std::pair{789, 3431},
        std::pair{790, 3790},
        std::pair{791, 3494},
        std::pair{792, 63947},
        std::pair{793, 6288},
        std::pair{794, 5799},
        std::pair{795, 3683},
        std::pair{796, 3744},
        std::pair{797, 4760},
        std::pair{798, 4114},
        std::pair{799, 3219},
        std::pair{800, 3367},
        std::pair{801, 3624},
        std::pair{802, 3330},
        std::pair{803, 3176},
        std::pair{804, 3245},
        std::pair{805, 2876},
        std::pair{806, 3244},
        std::pair{807, 3080},
        std::pair{808, 3182},
        std::pair{809, 4043},
        std::pair{810, 3215},
        std::pair{811, 2813},
        std::pair{812, 3084},
        std::pair{814, 3276},
        std::pair{816, 29033},
        std::pair{817, 3045},
        std::pair{818, 3155},
        std::pair{822, 2758},
        std::pair{823, 2750},
        std::pair{824, 3491},
        std::pair{825, 3105},
        std::pair{826, 3058},
        std::pair{827, 3252},
        std::pair{830, 2795},
        std::pair{834, 2980},
        std::pair{837, 2934},
        std::pair{847, 2915},
        std::pair{849, 2906},
        std::pair{851, 2832},
        std::pair{852, 4775},
        std::pair{853, 5139},
        std::pair{854, 2891},
        std::pair{857, 12174},
        std::pair{860, 3804},
        std::pair{861, 3610},
        std::pair{868, 9452},
        std::pair{869, 3193},
        std::pair{870, 4421},
        std::pair{871, 2741},
        std::pair{872, 2658},
        std::pair{880, 5565},
        std::pair{881, 4822},
        std::pair{887, 7897},
        std::pair{889, 2571},
        std::pair{893, 2772},
        std::pair{899, 2902},
        std::pair{900, 2563},
        std::pair{908, 3615},
        std::pair{909, 3335},
        std::pair{914, 2471},
        std::pair{915, 3855},
        std::pair{929, 2669},
        std::pair{931, 2727},
        std::pair{932, 3965},
        std::pair{933, 3861},
        std::pair{947, 2497},
        std::pair{948, 3413},
        std::pair{956, 7964},
        std::pair{957, 4164},
        std::pair{958, 15318},
        std::pair{970, 4944},
        std::pair{973, 5329},
        std::pair{991, 4237},
        std::pair{1009, 2996},
        std::pair{1013, 2317},
        std::pair{1018, 2403},
        std::pair{1021, 2264},
        std::pair{1027, 2432},
        std::pair{1028, 3170},
        std::pair{1029, 2282},
        std::pair{1062, 2136},
        std::pair{1063, 6545},
        std::pair{1065, 3930},
        std::pair{1071, 2748},
        std::pair{1073, 4453},
        std::pair{1080, 2280},
        std::pair{1081, 2917},
        std::pair{1086, 38785},
        std::pair{1088, 8662},
        std::pair{1094, 5021},
        std::pair{1095, 2231},
        std::pair{1097, 2063},
        std::pair{1099, 2050},
        std::pair{1111, 17965},
        std::pair{1112, 2278},
        std::pair{1117, 4879},
        std::pair{1118, 2130},
        std::pair{1122, 2016},
        std::pair{1129, 3118},
        std::pair{1131, 5241},
        std::pair{1132, 2044},
        std::pair{1133, 7119},
        std::pair{1134, 8941},
        std::pair{1137, 2184},
        std::pair{1138, 2896},
        std::pair{1140, 9739},
        std::pair{1145, 5445},
        std::pair{1157, 7559},
        std::pair{1158, 2301},
        std::pair{1183, 2098},
        std::pair{1191, 5395},
        std::pair{1192, 4617},
        std::pair{1195, 5422},
        std::pair{1203, 2285},
        std::pair{1206, 3310},
        std::pair{1211, 2079},
        std::pair{1212, 5269},
        std::pair{1214, 19082},
        std::pair{1215, 1876},
        std::pair{1229, 2511},
        std::pair{1230, 2021},
        std::pair{1232, 19221},
        std::pair{1233, 2398},
        std::pair{1235, 2863},
        std::pair{1237, 2601},
        std::pair{1238, 1942},
        std::pair{1242, 1855},
        std::pair{1252, 1814},
        std::pair{1259, 8921},
        std::pair{1260, 2166},
        std::pair{1270, 2508},
        std::pair{1276, 1983},
        std::pair{1292, 2651},
        std::pair{1303, 2344},
        std::pair{1304, 1984},
        std::pair{1305, 2837},
        std::pair{1316, 1784},
        std::pair{1343, 2431},
        std::pair{1347, 40393},
        std::pair{1349, 2713},
        std::pair{1363, 20803},
        std::pair{1381, 1940},
        std::pair{1382, 1738},
        std::pair{1383, 1792},
        std::pair{1398, 1924},
        std::pair{1399, 2076},
        std::pair{1402, 3204},
        std::pair{1403, 4854},
        std::pair{1404, 4220},
        std::pair{1411, 1789},
        std::pair{1430, 2616},
        std::pair{1439, 1556},
        std::pair{1448, 2535},
        std::pair{1450, 1738},
        std::pair{1463, 2819},
        std::pair{1464, 3412},
        std::pair{1469, 2184},
        std::pair{1487, 1571},
        std::pair{1501, 3647},
        std::pair{1504, 1622},
        std::pair{1505, 1540},
        std::pair{1535, 3421},
        std::pair{1564, 2720},
        std::pair{1580, 1699},
        std::pair{1581, 5728},
        std::pair{1583, 2487},
        std::pair{1600, 1513},
        std::pair{1601, 1637},
        std::pair{1602, 1908},
        std::pair{1603, 1840},
        std::pair{1604, 2253},
        std::pair{1605, 2171},
        std::pair{1606, 2151},
        std::pair{1607, 2077},
        std::pair{1608, 2025},
        std::pair{1609, 1924},
        std::pair{1610, 1893},
        std::pair{1611, 1591},
        std::pair{1612, 1521},
        std::pair{1613, 1622},
        std::pair{1618, 1998},
        std::pair{1693, 7588},
        std::pair{1748, 1796},
        std::pair{1752, 1707},
        std::pair{1757, 2606},
        std::pair{1758, 3088},
        std::pair{1759, 1301},
        std::pair{1765, 2397},
        std::pair{1779, 1451},
        std::pair{1789, 1658},
        std::pair{1799, 1425},
        std::pair{1800, 1988},
        std::pair{1810, 1337},
        std::pair{1819, 1582},
        std::pair{1820, 1482},
        std::pair{1821, 1339},
        std::pair{1822, 1574},
        std::pair{1823, 1531},
        std::pair{1824, 1598},
        std::pair{1825, 1574},
        std::pair{1826, 1718},
        std::pair{1827, 1605},
        std::pair{1828, 1567},
        std::pair{1829, 1782},
        std::pair{1830, 1622},
        std::pair{1831, 1934},
        std::pair{1832, 1483},
        std::pair{1833, 1323},
        std::pair{1834, 1416},
        std::pair{1839, 1248},
        std::pair{1880, 1503},
        std::pair{1897, 2634},
        std::pair{1912, 1334},
        std::pair{1935, 1200},
        std::pair{1938, 1477},
        std::pair{1939, 1251},
        std::pair{1941, 1367},
        std::pair{1943, 2004},
        std::pair{1945, 1678},
        std::pair{1947, 1489},
        std::pair{1949, 1469},
        std::pair{1951, 1542},
        std::pair{1953, 1825},
        std::pair{1955, 1262},
        std::pair{1957, 1362},
        std::pair{1959, 1384},
        std::pair{1961, 1281},
        std::pair{1965, 1244},
        std::pair{1967, 1208},
        std::pair{2007, 1280},
        std::pair{2015, 1865},
        std::pair{2028, 1828},
        std::pair{2029, 1492},
        std::pair{2138, 1528},
        std::pair{2164, 1259},
        std::pair{2238, 2749},
        std::pair{2239, 1165},
        std::pair{2243, 1008},
        std::pair{2293, 1132},
        std::pair{2329, 1039},
        std::pair{2330, 1025},
        std::pair{2331, 968},
        std::pair{2434, 3310},
        std::pair{2439, 1241},
        std::pair{2665, 860},
        std::pair{2755, 1050},
        std::pair{2768, 863},
        std::pair{2784, 1633},
        std::pair{2791, 1140},
        std::pair{2873, 1881},
        std::pair{2973, 874},
        std::pair{2974, 1492},
        std::pair{3023, 825},
        std::pair{3097, 765},
        std::pair{3098, 1285},
        std::pair{3102, 1676},
        std::pair{3107, 1090},
        std::pair{3108, 782},
        std::pair{3124, 1695},
        std::pair{3134, 878},
        std::pair{3161, 1927},
        std::pair{3179, 843},
        std::pair{3245, 1628},
        std::pair{3249, 1787},
        std::pair{3268, 1275},
        std::pair{3293, 690},
        std::pair{3305, 1073},
        std::pair{3306, 1256},
        std::pair{3360, 2382},
        std::pair{3375, 688},
        std::pair{3418, 957},
        std::pair{3489, 953},
        std::pair{3529, 960},
        std::pair{3567, 714},
        std::pair{3586, 687},
        std::pair{3589, 679},
        std::pair{3718, 1482},
        std::pair{3729, 635},
        std::pair{3776, 693},
        std::pair{3779, 611},
        std::pair{3784, 1072},
        std::pair{3854, 1671},
        std::pair{3865, 609},
        std::pair{3932, 646},
        std::pair{3983, 569},
        std::pair{3990, 7442},
        std::pair{4007, 1967},
        std::pair{4022, 856},
        std::pair{4033, 600},
        std::pair{4096, 3905157},
        std::pair{4197, 854},
        std::pair{4201, 839},
        std::pair{4206, 1126},
        std::pair{4252, 940},
        std::pair{4573, 613},
        std::pair{4578, 3187},
        std::pair{4880, 4217},
        std::pair{5229, 503},
        std::pair{5662, 418},
        std::pair{6103, 629},
        std::pair{6111, 1099},
        std::pair{7230, 516},
        std::pair{7950, 1340},
        std::pair{9163, 349},
        std::pair{9425, 1030},
        std::pair{10626, 2763},
        std::pair{11910, 1120},
        std::pair{12322, 461},
        std::pair{12463, 218},
        std::pair{12647, 505},
        std::pair{12764, 251},
        std::pair{14821, 161},
        std::pair{16220, 266},
        std::pair{19421, 207},
        std::pair{22287, 112},
        std::pair{23659, 205},
        std::pair{29024, 112},
        std::pair{32311, 161},
        std::pair{33016, 101},
        std::pair{35830, 65},
        std::pair{37830, 134},
        std::pair{42651, 255},
        std::pair{51830, 62},
        std::pair{51975, 54},
        std::pair{58763, 48},
        std::pair{58957, 65},
        std::pair{58959, 190},
        std::pair{58968, 45},
        std::pair{59029, 91},
        std::pair{65973, 109},
        std::pair{67108, 51},
        std::pair{73348, 46},
        std::pair{73350, 56},
        std::pair{88154, 147},
        std::pair{93902, 252},
        std::pair{95844, 26},
        std::pair{95901, 6384},
        std::pair{105054, 160},
        std::pair{116108, 143},
        std::pair{116132, 28},
        std::pair{120562, 19},
        std::pair{129509, 21},
        std::pair{131887, 112},
        std::pair{134762, 66},
        std::pair{142727, 79},
        std::pair{156030, 20},
        std::pair{157030, 59},
        std::pair{158830, 19},
        std::pair{160030, 47},
        std::pair{161030, 27},
        std::pair{170730, 15},
        std::pair{172242, 48},
        std::pair{185416, 15},
        std::pair{188014, 34},
        std::pair{201064, 18},
        std::pair{201956, 308},
        std::pair{212447, 71},
        std::pair{238133, 11},
        std::pair{248911, 14},
        std::pair{263128, 382},
        std::pair{263715, 109},
        std::pair{263717, 64},
        std::pair{263826, 12},
        std::pair{264526, 14},
        std::pair{281222, 15},
        std::pair{296649, 20},
        std::pair{304568, 9},
        std::pair{313930, 10},
        std::pair{330734, 11},
        std::pair{360543, 9},
        std::pair{366453, 7},
        std::pair{376701, 7},
        std::pair{390618, 7},
        std::pair{393960, 13},
        std::pair{397614, 9},
        std::pair{3208728, 1},
        std::pair{3399235, 1},
        std::pair{3455039, 1},
        std::pair{3901276, 1},
        std::pair{3938182, 1},
        std::pair{3940737, 1},
        std::pair{3960783, 1},
        std::pair{3969293, 1},
        std::pair{3979245, 1},
        std::pair{3983549, 1},
        std::pair{3988760, 1},
        std::pair{3990061, 1},
        std::pair{3990887, 1},
        std::pair{3990916, 1},
        std::pair{3990944, 1},
        std::pair{3991041, 1},
        std::pair{3991516, 1},
        std::pair{3992188, 1},
        std::pair{3992381, 1},
        std::pair{3992470, 1},
    };

    constexpr auto scaling_factor{1'000'000U}; // Scale to this many occurrences of 1 byte vectors
    const uint64_t max_count{histogram[1]};
    assert(max_count == 47'584'838'861); // 1 byte vectors are most frequent

    std::vector<std::vector<std::byte>> test_data;
    test_data.reserve(1'941'283);

    FastRandomContext rng{/*fDeterministic=*/true};
    uint64_t total_bytes{0};
    for (const auto& [size, count] : histogram) {
        const size_t scaled_count{static_cast<size_t>(std::ceil(static_cast<double>(count) / max_count * scaling_factor))};

        total_bytes += scaled_count * size;
        auto rand_bytes = rng.randbytes<std::byte>(size);
        for (size_t j{0}; j < scaled_count; ++j) {
            test_data.emplace_back(rand_bytes);
        }
    }
    assert(total_bytes == 114'929'502);

    std::ranges::shuffle(test_data, rng); // Make it more realistic & less predictable

    std::vector key_bytes{rng.randbytes<std::byte>(8)};
    uint64_t key;
    std::memcpy(&key, key_bytes.data(), 8);

    size_t offset{0};
    bench.batch(total_bytes).unit("byte").run([&] {
        for (auto& data : test_data) {
            util::Xor(data, key_bytes, offset++);
        }
        ankerl::nanobench::doNotOptimizeAway(test_data);
    });
}

static void AutoFileXor(benchmark::Bench& bench)
{
    FastRandomContext rng{/*fDeterministic=*/true};
    const auto data{rng.randbytes<std::byte>(1'000'000)};

    const std::vector empty_key_bytes(8, std::byte{0}); // Test disabled xor
    uint64_t empty_key;
    std::memcpy(&empty_key, empty_key_bytes.data(), 8);

    const fs::path test_path = fs::temp_directory_path() / "xor_benchmark.dat";
    AutoFile f{fsbridge::fopen(test_path, "wb+"), empty_key_bytes};
    bench.batch(data.size()).unit("byte").run([&] {
        f.Truncate(0);
        f << data;
    });
    try { fs::remove(test_path); } catch (const fs::filesystem_error&) {}
}

BENCHMARK(XorHistogram, benchmark::PriorityLevel::LOW);
BENCHMARK(AutoFileXor, benchmark::PriorityLevel::LOW);
