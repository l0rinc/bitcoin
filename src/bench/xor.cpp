// Copyright (c) The Bitcoin Core developers
// Distributed under the MIT software license, see the accompanying
// file COPYING or https://opensource.org/license/mit/.

#include <bench/bench.h>
#include <random.h>
#include <span.h>
#include <streams.h>

#include <cmath>
#include <cstddef>
#include <map>
#include <vector>

static void XorHistogram(benchmark::Bench& bench)
{
    // The histogram represents util::Xor method's write.size() histograms for the first ~700k blocks, aggregated using:
    // awk '{ count[$1]++ } END { for (val in count) { printf "{%s, %.0f},\n", val, count[val] } }' histogram.txt
    const std::map<size_t, uint64_t> raw_histogram{
        {1, 27'967'118'710},
        {2, 136'880'453},
        {3, 5'201},
        {4, 9'709'037'491},
        {5, 4'017},
        {6, 50'763},
        {7, 126'987},
        {8, 3'734'356'603},
        {9, 246'257},
        {10, 197'985},
        {11, 838'648},
        {12, 131'150},
        {13, 92'005},
        {14, 83'304},
        {15, 67'499},
        {16, 81'550},
        {17, 66'879},
        {18, 53'000},
        {19, 58'465},
        {20, 54'372},
        {21, 1'635'157'213},
        {22, 391'558'401},
        {23, 1'568'979'765},
        {24, 12'680},
        {25, 2'373'224'081},
        {26, 27'611'493},
        {27, 51'111'386},
        {28, 26'664'402},
        {29, 4'427'065},
        {30, 3'076'804},
        {31, 212'790},
        {32, 3'490'403'783},
        {33, 788'619'577},
        {34, 30'819'752},
        {35, 193'242'413},
        {36, 174'089},
        {37, 26'477'385},
        {38, 818'142},
        {39, 250'866},
        {40, 138'281},
        {41, 515'324},
        {42, 1'662'615},
        {43, 203'133},
        {44, 159'088},
        {45, 16'306},
        {46, 83'478},
        {47, 59'437},
        {48, 662'367},
        {49, 16'013},
        {50, 11'900},
        {51, 15'870},
        {52, 21'005},
        {53, 294'875},
        {54, 19'647},
        {55, 13'406},
        {56, 499'823},
        {57, 21'572},
        {58, 29'291},
        {59, 31'658},
        {60, 11'812},
        {61, 11'166},
        {62, 46'902},
        {63, 19'280},
        {64, 51'298},
        {65, 23'385},
        {66, 172'123},
        {67, 1'742'178},
        {68, 31'226},
        {69, 70'756},
        {70, 5'432'377},
        {71, 823'896'649},
        {72, 404'372'026},
        {73, 3'636'333},
        {74, 709'084},
        {75, 62'192},
        {76, 28'744},
        {77, 419'464},
        {78, 713'619},
        {79, 16'640},
        {80, 16'756},
        {81, 12'756},
        {82, 27'296},
        {83, 49'296'947},
        {84, 27'948},
        {85, 31'729},
        {86, 11'324},
        {87, 5'607},
        {88, 670'995},
        {89, 8'194},
        {90, 6'661},
        {91, 20'405},
        {92, 11'542},
        {93, 13'037},
        {94, 35'961},
        {95, 3'967'916},
        {96, 52'306},
        {97, 380'506},
        {98, 110'349},
        {99, 188'833},
        {100, 330'405},
        {101, 1'970},
        {102, 4},
        {103, 66'794},
        {104, 61'590},
        {105, 121'280'804},
        {106, 1'002'482'474},
        {107, 933'140'175},
        {108, 22'992'541},
        {109, 49'442},
        {110, 70'109},
        {111, 504'873},
        {112, 314'599},
        {113, 1'772},
        {114, 318},
        {115, 1'844},
        {116, 1'478},
        {117, 35},
        {118, 10},
        {119, 2},
        {122, 8},
        {123, 12},
        {125, 18},
        {126, 4'570},
        {127, 1'102'682},
        {128, 10},
        {129, 10},
        {130, 204'958},
        {131, 248},
        {132, 33'599},
        {133, 23'816},
        {134, 41},
        {135, 198'213},
        {136, 5'898},
        {137, 952'225},
        {138, 104'787'369},
        {139, 143'759'368},
        {140, 37'615'873},
        {141, 695},
        {142, 10'386},
        {143, 13'071},
        {144, 79'695},
        {145, 893'613},
        {146, 882'067},
        {147, 3'140},
        {148, 3'863},
        {149, 23},
        {150, 18},
        {151, 16},
        {152, 4},
        {153, 6},
        {154, 1'257},
        {155, 1'404},
        {156, 157},
        {157, 151},
        {159, 6},
        {160, 12},
        {161, 12},
        {162, 10},
        {163, 1'983},
        {164, 233'821},
        {165, 236'165},
        {166, 32'058},
        {167, 32'578},
        {168, 140},
        {169, 122},
        {170, 7},
        {171, 12},
        {172, 26},
        {173, 173'224},
        {174, 18},
        {175, 15},
        {176, 21},
        {177, 20},
        {178, 1'743},
        {179, 2'140},
        {180, 47'457},
        {181, 47'092},
        {182, 94},
        {183, 459},
        {184, 441},
        {185, 52},
        {186, 170},
        {187, 93},
        {188, 58},
        {189, 239},
        {190, 323},
        {191, 85},
        {192, 50},
        {193, 72},
        {194, 10},
        {195, 108},
        {196, 117},
        {197, 99},
        {198, 149'024},
        {199, 174},
        {200, 22},
        {201, 34'103},
        {202, 333},
        {203, 91},
        {204, 6},
        {205, 42},
        {206, 101},
        {207, 32'419},
        {208, 285},
        {209, 35},
        {210, 204},
        {211, 460},
        {212, 264},
        {213, 69},
        {214, 9'268},
        {215, 12'406},
        {216, 204'520},
        {217, 13'189'158},
        {218, 25'606'888},
        {219, 12'858'475},
        {220, 93'843},
        {221, 21'416},
        {222, 172},
        {223, 199},
        {224, 36},
        {225, 56},
        {226, 40},
        {227, 497},
        {228, 1'083},
        {229, 771},
        {230, 397},
        {231, 170},
        {232, 8},
        {233, 18},
        {234, 27},
        {235, 372},
        {236, 347},
        {237, 14},
        {238, 8},
        {239, 512},
        {240, 14'097},
        {241, 36'528},
        {242, 14'127},
        {243, 424},
        {244, 19},
        {245, 61},
        {246, 45},
        {247, 54},
        {248, 5'512},
        {249, 5'940},
        {250, 21'658},
        {251, 671'744},
        {252, 43'440'919},
        {253, 77'812'147},
        {254, 36'923'538},
        {255, 141'835},
        {256, 21'148},
        {257, 32},
        {258, 51},
        {259, 48},
        {260, 53},
        {261, 3'059},
        {262, 6'236},
        {263, 3'187},
        {264, 220},
        {265, 170},
        {266, 456},
        {267, 43},
        {268, 19},
        {269, 12},
        {270, 83},
        {271, 88},
        {272, 6},
        {274, 14},
        {275, 431},
        {276, 423},
        {277, 74},
        {278, 124},
        {279, 1'443},
        {280, 1'467},
        {281, 85},
        {282, 8'306},
        {283, 15'078},
        {284, 299'936},
        {285, 336'499},
        {286, 334'016},
        {287, 319'490},
        {288, 160'076},
        {289, 194},
        {290, 78},
        {291, 12},
        {292, 18},
        {293, 10},
        {294, 22},
        {295, 12},
        {296, 4},
        {297, 5},
        {298, 8},
        {299, 10},
        {300, 2},
        {301, 6},
        {302, 14},
        {303, 34},
        {304, 70},
        {305, 41},
        {306, 2},
        {307, 36},
        {308, 1'828},
        {309, 1'823},
        {310, 2},
        {311, 8},
        {312, 4},
        {313, 8},
        {314, 46},
        {315, 93},
        {316, 2'209},
        {317, 5'023},
        {318, 3'937},
        {319, 11'216},
        {320, 35'696},
        {321, 40'476},
        {322, 18'521},
        {323, 5'224},
        {324, 31'003},
        {325, 19'568},
        {326, 19'973},
        {327, 7'139},
        {328, 579},
        {329, 258},
        {330, 82},
        {331, 42},
        {332, 20},
        {333, 837},
        {334, 10},
        {335, 20},
        {336, 2},
        {337, 8},
        {338, 10},
        {339, 40},
        {340, 24},
        {341, 2},
        {343, 828},
        {344, 1'534},
        {345, 760},
        {346, 95},
        {347, 8'884},
        {348, 584'278},
        {349, 1'123'867},
        {350, 572'648},
        {351, 8'276},
        {352, 2'041},
        {353, 3'997},
        {354, 257'745},
        {355, 508'484},
        {356, 255'352},
        {357, 807},
        {358, 30'204},
        {359, 68'965},
        {360, 72'656},
        {361, 29'670},
        {362, 4'800},
        {363, 1'740},
        {364, 401},
        {365, 29},
        {366, 10},
        {367, 4},
        {368, 21},
        {369, 64},
        {370, 36},
        {371, 14},
        {372, 8},
        {373, 20},
        {374, 22},
        {375, 5},
        {376, 2},
        {377, 8'345},
        {379, 2},
        {380, 9},
        {381, 6},
        {382, 20},
        {383, 8},
        {384, 2},
        {385, 12},
        {386, 18},
        {387, 12},
        {388, 359},
        {389, 562},
        {390, 375},
        {391, 6'401},
        {392, 277'298},
        {393, 784'201},
        {394, 778'156},
        {395, 258'489},
        {396, 190},
        {397, 146},
        {398, 116},
        {399, 70},
        {400, 28},
        {401, 37},
        {402, 26},
        {403, 22},
        {404, 20},
        {405, 24},
        {406, 20},
        {407, 8},
        {408, 14},
        {409, 14},
        {410, 16},
        {411, 8},
        {412, 4},
        {414, 19},
        {415, 710},
        {416, 1'846},
        {417, 2'001},
        {418, 1'019},
        {419, 283},
        {420, 54},
        {421, 152},
        {422, 189},
        {423, 845},
        {424, 1'521},
        {425, 1'108},
        {426, 8'626},
        {427, 24'403},
        {428, 23'802},
        {429, 7'969},
        {430, 218},
        {431, 741},
        {432, 1'106},
        {433, 740},
        {434, 204},
        {436, 8},
        {437, 4},
        {438, 14},
        {439, 2},
        {440, 4},
        {441, 4},
        {442, 2},
        {443, 13},
        {444, 31},
        {445, 30},
        {446, 2},
        {451, 11},
        {452, 3},
        {453, 10},
        {454, 2},
        {455, 2},
        {456, 12},
        {457, 539},
        {458, 1'008},
        {459, 892},
        {460, 15'408},
        {461, 24'389},
        {462, 19'987},
        {463, 6'872},
        {464, 2'665},
        {465, 6'339},
        {466, 8'231},
        {467, 5'696},
        {468, 1'430},
        {469, 2},
        {470, 4},
        {471, 12},
        {472, 6},
        {473, 6},
        {474, 2},
        {475, 16},
        {476, 21},
        {477, 14},
        {478, 7},
        {479, 2},
        {481, 15},
        {482, 24},
        {483, 24},
        {484, 26},
        {485, 425},
        {486, 35'944},
        {487, 1'571'665},
        {488, 4'396'916},
        {489, 4'224'340},
        {490, 1'367'001},
        {491, 838},
        {492, 353},
        {493, 60},
        {494, 28},
        {495, 683},
        {496, 2'019},
        {497, 2'110},
        {498, 5'036},
        {499, 13'755},
        {500, 20'227},
        {501, 13'360},
        {502, 3'356},
        {504, 2},
        {505, 10},
        {506, 12},
        {507, 8},
        {508, 6},
        {509, 2},
        {511, 12},
        {512, 4},
        {513, 56},
        {514, 4},
        {515, 8},
        {516, 4},
        {517, 6},
        {519, 2},
        {520, 2},
        {521, 2},
        {522, 6},
        {523, 14},
        {524, 8},
        {525, 6},
        {526, 14},
        {527, 1'188},
        {528, 10},
        {529, 30},
        {530, 84},
        {531, 80},
        {532, 622},
        {533, 2'317},
        {534, 3'323},
        {535, 2'232},
        {536, 637},
        {537, 231},
        {538, 464},
        {539, 438},
        {540, 245},
        {541, 1'820},
        {542, 1'844},
        {543, 4},
        {544, 12},
        {545, 2},
        {546, 8},
        {547, 18},
        {548, 16},
        {549, 12},
        {551, 2},
        {552, 75},
        {553, 3'453},
        {554, 10'525},
        {555, 10'558},
        {556, 3'738},
        {557, 246},
        {558, 118},
        {559, 28},
        {560, 8},
        {561, 32},
        {562, 22},
        {563, 28},
        {564, 30},
        {565, 14},
        {566, 10},
        {567, 8},
        {568, 12},
        {569, 32},
        {570, 44},
        {571, 50},
        {572, 72},
        {573, 34},
        {574, 38},
        {575, 16},
        {577, 2},
        {578, 8},
        {580, 12},
        {581, 12},
        {582, 2},
        {583, 10},
        {584, 60},
        {585, 60},
        {587, 8},
        {588, 4},
        {589, 36},
        {590, 26},
        {591, 4},
        {592, 6},
        {594, 8},
        {595, 805},
        {596, 759},
        {597, 2},
        {598, 4},
        {600, 14},
        {601, 638},
        {602, 2'540},
        {603, 3'343},
        {604, 2'176},
        {605, 622},
        {606, 278},
        {607, 215},
        {608, 122},
        {609, 20},
        {610, 4},
        {613, 2},
        {614, 8},
        {617, 4},
        {618, 93},
        {619, 6},
        {620, 12},
        {621, 8},
        {622, 10},
        {623, 10},
        {625, 4},
        {626, 4},
        {627, 56},
        {628, 41'420},
        {629, 29},
        {630, 4},
        {631, 4},
        {632, 2},
        {636, 4},
        {638, 2},
        {639, 19},
        {640, 74},
        {641, 119},
        {642, 127},
        {643, 59},
        {644, 27},
        {645, 24},
        {646, 34},
        {647, 24},
        {648, 2},
        {650, 2},
        {651, 4},
        {652, 6},
        {653, 4},
        {654, 2},
        {655, 44},
        {656, 2},
        {657, 5},
        {658, 1},
        {659, 1},
        {660, 4},
        {661, 50},
        {662, 62},
        {663, 34},
        {667, 6},
        {672, 4},
        {673, 18},
        {674, 12},
        {675, 46},
        {676, 44},
        {677, 22},
        {678, 12},
        {679, 4},
        {680, 6},
        {685, 2},
        {686, 8},
        {687, 6},
        {688, 2},
        {689, 4},
        {690, 2},
        {691, 4},
        {692, 6},
        {693, 10},
        {694, 8},
        {695, 2},
        {697, 8},
        {698, 14},
        {699, 17},
        {700, 34},
        {701, 22},
        {702, 14},
        {703, 14},
        {704, 6},
        {705, 4},
        {708, 6},
        {709, 6},
        {710, 16},
        {711, 13},
        {712, 6},
        {714, 4},
        {715, 2},
        {717, 2},
        {718, 2},
        {719, 2},
        {721, 4},
        {724, 4},
        {725, 2},
        {727, 2},
        {728, 2},
        {730, 4},
        {731, 2},
        {733, 10},
        {734, 12},
        {735, 22},
        {736, 4},
        {739, 2},
        {740, 2},
        {741, 2},
        {743, 4},
        {745, 2},
        {746, 4},
        {747, 8},
        {748, 8},
        {749, 14},
        {750, 20},
        {751, 35},
        {752, 43},
        {753, 28},
        {754, 10},
        {755, 8},
        {756, 27},
        {757, 101},
        {758, 371},
        {759, 503},
        {760, 351},
        {761, 127},
        {762, 10},
        {763, 10},
        {764, 4},
        {765, 4},
        {766, 4},
        {767, 4},
        {768, 6},
        {769, 4},
        {771, 2},
        {772, 2},
        {773, 2},
        {774, 6},
        {779, 2},
        {781, 6},
        {782, 4},
        {783, 2},
        {785, 2},
        {787, 2},
        {789, 4},
        {792, 2},
        {794, 4},
        {796, 2},
        {797, 4},
        {802, 10},
        {804, 2},
        {805, 2},
        {807, 26},
        {808, 6},
        {811, 2},
        {812, 2},
        {813, 4},
        {814, 6},
        {815, 4},
        {816, 20},
        {817, 14},
        {818, 4},
        {819, 10},
        {820, 8},
        {821, 2},
        {823, 4},
        {825, 2},
        {826, 2},
        {827, 2},
        {829, 2},
        {830, 8},
        {831, 7},
        {832, 6},
        {833, 6},
        {834, 2},
        {835, 2},
        {836, 2},
        {838, 4},
        {841, 2},
        {843, 4},
        {847, 8},
        {852, 2},
        {853, 2},
        {854, 2},
        {855, 4},
        {856, 14},
        {857, 28},
        {858, 64},
        {859, 83},
        {860, 60},
        {861, 33},
        {862, 16},
        {863, 4},
        {865, 2},
        {866, 2},
        {867, 4},
        {871, 2},
        {874, 2},
        {875, 4},
        {876, 2},
        {877, 2},
        {878, 4},
        {879, 10},
        {880, 8},
        {881, 18},
        {882, 56},
        {883, 144},
        {884, 182},
        {885, 131},
        {886, 42},
        {887, 4},
        {889, 2},
        {893, 4},
        {895, 6},
        {896, 2},
        {900, 2},
        {902, 2},
        {905, 4},
        {906, 2},
        {907, 2},
        {916, 6},
        {917, 4},
        {922, 4},
        {923, 2},
        {924, 4},
        {926, 6},
        {928, 2},
        {929, 2},
        {935, 4},
        {942, 4},
        {943, 2},
        {945, 2},
        {946, 2},
        {947, 2},
        {952, 10},
        {953, 26},
        {954, 86},
        {955, 264},
        {956, 504},
        {957, 443},
        {958, 262},
        {959, 76},
        {960, 20},
        {961, 4},
        {962, 6},
        {963, 8},
        {964, 20},
        {965, 32},
        {966, 22},
        {967, 18},
        {968, 6},
        {969, 4},
        {970, 2},
        {974, 4},
        {975, 6},
        {976, 10},
        {977, 17},
        {978, 10},
        {979, 10},
        {980, 8},
        {981, 8},
        {982, 2},
        {983, 2},
        {987, 4},
        {991, 4},
        {993, 2},
        {995, 6},
        {996, 12},
        {997, 24},
        {999, 2},
        {1000, 6},
        {1001, 4},
        {1005, 4},
        {1006, 2},
        {1007, 2},
        {1009, 2},
        {1010, 14},
        {1011, 10},
        {1012, 2},
        {1013, 2},
        {1016, 4},
        {1017, 2},
        {1018, 2},
        {1020, 4},
        {1022, 2},
        {1023, 2},
        {1025, 4},
        {1026, 2},
        {1027, 2},
        {1033, 2},
        {1034, 4},
        {1035, 4},
        {1036, 2},
        {1037, 2},
        {1038, 2},
        {1039, 12},
        {1041, 8},
        {1042, 2},
        {1043, 4},
        {1044, 4},
        {1045, 6},
        {1046, 6},
        {1047, 6},
        {1048, 4},
        {1049, 2},
        {1050, 8},
        {1051, 6},
        {1052, 10},
        {1053, 8},
        {1054, 6},
        {1055, 18},
        {1056, 10},
        {1057, 14},
        {1058, 6},
        {1059, 16},
        {1060, 4},
        {1061, 20},
        {1062, 12},
        {1063, 16},
        {1064, 14},
        {1065, 14},
        {1066, 24},
        {1067, 10},
        {1068, 16},
        {1069, 23},
        {1070, 22},
        {1071, 18},
        {1072, 39},
        {1073, 31},
        {1074, 44},
        {1075, 56},
        {1076, 46},
        {1077, 78},
        {1078, 54},
        {1079, 52},
        {1080, 44},
        {1081, 26},
        {1082, 12},
        {1083, 26},
        {1084, 24},
        {1085, 22},
        {1086, 20},
        {1087, 16},
        {1088, 32},
        {1089, 40},
        {1090, 24},
        {1091, 26},
        {1092, 64},
        {1093, 58},
        {1094, 36},
        {1095, 61},
        {1096, 50},
        {1097, 75},
        {1098, 56},
        {1099, 60},
        {1100, 40},
        {1101, 60},
        {1102, 38},
        {1103, 34},
        {1104, 48},
        {1105, 40},
        {1106, 48},
        {1107, 34},
        {1108, 30},
        {1109, 32},
        {1110, 40},
        {1111, 48},
        {1112, 36},
        {1113, 30},
        {1114, 48},
        {1115, 34},
        {1116, 44},
        {1117, 32},
        {1118, 60},
        {1119, 44},
        {1120, 66},
        {1121, 36},
        {1122, 56},
        {1123, 44},
        {1124, 52},
        {1125, 32},
        {1126, 60},
        {1127, 25},
        {1128, 48},
        {1129, 40},
        {1130, 40},
        {1131, 38},
        {1132, 52},
        {1133, 30},
        {1134, 44},
        {1135, 36},
        {1136, 54},
        {1137, 52},
        {1138, 46},
        {1139, 50},
        {1140, 40},
        {1141, 42},
        {1142, 52},
        {1143, 30},
        {1144, 36},
        {1145, 36},
        {1146, 42},
        {1147, 52},
        {1148, 50},
        {1149, 44},
        {1150, 44},
        {1151, 38},
        {1152, 50},
        {1153, 44},
        {1154, 44},
        {1155, 48},
        {1156, 34},
        {1157, 66},
        {1158, 60},
        {1159, 36},
        {1160, 46},
        {1161, 36},
        {1162, 62},
        {1163, 40},
        {1164, 40},
        {1165, 46},
        {1166, 38},
        {1167, 28},
        {1168, 48},
        {1169, 48},
        {1170, 43},
        {1171, 44},
        {1172, 32},
        {1173, 44},
        {1174, 38},
        {1175, 36},
        {1176, 38},
        {1177, 30},
        {1178, 40},
        {1179, 46},
        {1180, 46},
        {1181, 26},
        {1182, 40},
        {1183, 26},
        {1184, 32},
        {1185, 32},
        {1186, 28},
        {1187, 42},
        {1188, 28},
        {1189, 20},
        {1190, 24},
        {1191, 12},
        {1192, 28},
        {1193, 12},
        {1194, 16},
        {1195, 16},
        {1196, 24},
        {1197, 26},
        {1198, 12},
        {1199, 18},
        {1200, 12},
        {1201, 58},
        {1202, 58},
        {1203, 6},
        {1204, 6},
        {1205, 2},
        {1206, 2},
        {1207, 2},
        {1208, 4},
        {1209, 2},
        {1210, 12},
        {1212, 2},
        {1213, 6},
        {1214, 6},
        {1217, 2},
        {1218, 4},
        {1219, 2},
        {1220, 4},
        {1221, 6},
        {1222, 2},
        {1224, 6},
        {1225, 6},
        {1227, 8},
        {1228, 10},
        {1229, 14},
        {1230, 4},
        {1231, 4},
        {1232, 4},
        {1233, 4},
        {1234, 2},
        {1236, 6},
        {1237, 8},
        {1238, 8},
        {1239, 8},
        {1240, 2},
        {1241, 12},
        {1242, 14},
        {1243, 2},
        {1244, 8},
        {1245, 4},
        {1246, 8},
        {1247, 4},
        {1248, 8},
        {1249, 12},
        {1250, 6},
        {1251, 6},
        {1252, 6},
        {1253, 8},
        {1254, 2},
        {1257, 2},
        {1258, 12},
        {1259, 14},
        {1260, 4},
        {1261, 6},
        {1262, 8},
        {1263, 4},
        {1264, 6},
        {1265, 10},
        {1266, 8},
        {1267, 4},
        {1268, 14},
        {1269, 2},
        {1270, 10},
        {1271, 10},
        {1272, 16},
        {1273, 8},
        {1274, 8},
        {1275, 8},
        {1276, 2},
        {1277, 2},
        {1278, 2},
        {1279, 10},
        {1280, 4},
        {1281, 4},
        {1282, 6},
        {1283, 8},
        {1284, 10},
        {1285, 16},
        {1286, 6},
        {1287, 8},
        {1288, 4},
        {1289, 10},
        {1290, 10},
        {1291, 6},
        {1292, 6},
        {1293, 2},
        {1294, 8},
        {1295, 8},
        {1296, 8},
        {1297, 10},
        {1298, 4},
        {1299, 10},
        {1300, 8},
        {1301, 48},
        {1302, 8},
        {1303, 10},
        {1304, 12},
        {1305, 8},
        {1306, 10},
        {1307, 2},
        {1308, 6},
        {1309, 30},
        {1310, 6},
        {1311, 26},
        {1312, 78},
        {1313, 113},
        {1314, 146},
        {1315, 185},
        {1316, 100},
        {1317, 59},
        {1318, 30},
        {1319, 12},
        {1320, 22},
        {1321, 12},
        {1322, 2},
        {1323, 20},
        {1324, 6},
        {1325, 27},
        {1326, 10},
        {1327, 6},
        {1328, 10},
        {1329, 6},
        {1330, 10},
        {1331, 11},
        {1332, 4},
        {1333, 18},
        {1334, 6},
        {1335, 12},
        {1336, 10},
        {1337, 6},
        {1338, 10},
        {1339, 6},
        {1340, 18},
        {1341, 8},
        {1342, 16},
        {1343, 2},
        {1344, 6},
        {1345, 10},
        {1346, 14},
        {1347, 6},
        {1348, 4},
        {1349, 10},
        {1350, 14},
        {1351, 8},
        {1352, 4},
        {1353, 12},
        {1354, 8},
        {1355, 6},
        {1356, 8},
        {1357, 16},
        {1358, 6},
        {1359, 6},
        {1360, 8},
        {1361, 12},
        {1362, 14},
        {1363, 10},
        {1364, 6},
        {1365, 12},
        {1366, 6},
        {1367, 6},
        {1368, 4},
        {1369, 8},
        {1370, 14},
        {1371, 14},
        {1372, 10},
        {1373, 12},
        {1374, 14},
        {1375, 4},
        {1376, 12},
        {1377, 6},
        {1378, 16},
        {1379, 14},
        {1380, 12},
        {1381, 16},
        {1382, 16},
        {1383, 8},
        {1384, 8},
        {1385, 12},
        {1386, 10},
        {1387, 20},
        {1388, 21},
        {1389, 18},
        {1390, 21},
        {1391, 14},
        {1392, 22},
        {1393, 10},
        {1394, 4},
        {1395, 18},
        {1396, 16},
        {1397, 16},
        {1398, 14},
        {1399, 18},
        {1400, 8},
        {1401, 12},
        {1402, 2},
        {1403, 14},
        {1404, 10},
        {1405, 22},
        {1406, 12},
        {1407, 4},
        {1408, 12},
        {1409, 16},
        {1410, 10},
        {1411, 16},
        {1412, 26},
        {1413, 22},
        {1414, 18},
        {1415, 8},
        {1416, 10},
        {1417, 10},
        {1418, 26},
        {1419, 10},
        {1420, 18},
        {1421, 14},
        {1422, 12},
        {1423, 16},
        {1424, 18},
        {1425, 6},
        {1426, 8},
        {1427, 14},
        {1428, 16},
        {1429, 24},
        {1430, 16},
        {1431, 28},
        {1432, 18},
        {1433, 12},
        {1434, 20},
        {1435, 24},
        {1436, 20},
        {1437, 14},
        {1438, 10},
        {1439, 30},
        {1440, 20},
        {1441, 22},
        {1442, 30},
        {1443, 12},
        {1444, 16},
        {1445, 14},
        {1446, 26},
        {1447, 12},
        {1448, 18},
        {1449, 24},
        {1450, 28},
        {1451, 18},
        {1452, 20},
        {1453, 20},
        {1454, 28},
        {1455, 34},
        {1456, 30},
        {1457, 20},
        {1458, 18},
        {1459, 24},
        {1460, 12},
        {1461, 32},
        {1462, 23},
        {1463, 16},
        {1464, 20},
        {1465, 26},
        {1466, 34},
        {1467, 16},
        {1468, 20},
        {1469, 20},
        {1470, 28},
        {1471, 20},
        {1472, 14},
        {1473, 12},
        {1474, 42},
        {1475, 12},
        {1476, 92},
        {1477, 92},
        {1478, 22},
        {1479, 28},
        {1480, 30},
        {1481, 96},
        {1482, 68},
        {1483, 22},
        {1484, 36},
        {1485, 20},
        {1486, 34},
        {1487, 30},
        {1488, 48},
        {1489, 36},
        {1490, 28},
        {1491, 40},
        {1492, 32},
        {1493, 28},
        {1494, 88},
        {1495, 100},
        {1496, 28},
        {1497, 36},
        {1498, 32},
        {1499, 24},
        {1500, 38},
        {1501, 18},
        {1502, 26},
        {1503, 16},
        {1504, 42},
        {1505, 40},
        {1506, 38},
        {1507, 22},
        {1508, 22},
        {1509, 32},
        {1510, 46},
        {1511, 30},
        {1512, 32},
        {1513, 32},
        {1514, 52},
        {1515, 44},
        {1516, 26},
        {1517, 34},
        {1518, 46},
        {1519, 38},
        {1520, 42},
        {1521, 42},
        {1522, 52},
        {1523, 46},
        {1524, 32},
        {1525, 28},
        {1526, 50},
        {1527, 40},
        {1528, 18},
        {1529, 36},
        {1530, 38},
        {1531, 44},
        {1532, 30},
        {1533, 32},
        {1534, 86},
        {1535, 88},
        {1536, 52},
        {1537, 52},
        {1538, 34},
        {1539, 42},
        {1540, 78},
        {1541, 118},
        {1542, 40},
        {1543, 38},
        {1544, 44},
        {1545, 60},
        {1546, 22},
        {1547, 54},
        {1548, 56},
        {1549, 38},
        {1550, 40},
        {1551, 72},
        {1552, 42},
        {1553, 44},
        {1554, 42},
        {1555, 48},
        {1556, 58},
        {1557, 46},
        {1558, 52},
        {1559, 64},
        {1560, 50},
        {1561, 38},
        {1562, 58},
        {1563, 64},
        {1564, 26},
        {1565, 60},
        {1566, 48},
        {1567, 62},
        {1568, 62},
        {1569, 60},
        {1570, 42},
        {1571, 54},
        {1572, 28},
        {1573, 28},
        {1595, 2},
        {1597, 2},
        {1599, 2},
        {1600, 8},
        {1601, 4},
        {1602, 29},
        {1603, 34},
        {1604, 28},
        {1605, 32},
        {1606, 27},
        {1607, 18},
        {1608, 12},
        {1612, 2},
        {1623, 22},
        {1624, 22},
        {1639, 94},
        {1648, 6},
        {1649, 24},
        {1650, 22},
        {2983, 2},
        {3054, 14},
        {4026, 6},
        {4032, 3},
        {4096, 22},
        {7079, 2},
        {7150, 13},
        {9319, 3},
    };

    const auto max_count{static_cast<double>(raw_histogram.begin()->second)}; // 1 byte is the most common
    const auto SCALING_FACTOR{1'000'000U};

    FastRandomContext rng{/*fDeterministic=*/true};
    std::vector<std::vector<std::byte>> test_data;
    size_t total_bytes{0};
    for (const auto& [size, count] : raw_histogram) {
        const size_t scaled_count{static_cast<size_t>(std::ceil((static_cast<double>(count) / max_count) * SCALING_FACTOR))};
        total_bytes += scaled_count * size;
        for (size_t i{0}; i < scaled_count; ++i) {
            test_data.push_back(rng.randbytes<std::byte>(size));
        }
    }
    assert(total_bytes == 29'765'689);
    std::shuffle(test_data.begin(), test_data.end(), rng); // Make it more realistic & less predictable

    std::vector key_bytes{rng.randbytes<std::byte>(8)};
    uint64_t key;
    std::memcpy(&key, key_bytes.data(), 8);

    bench.batch(total_bytes).unit("byte").run([&] {
        for (size_t offset = 0; offset < 10; ++offset) {
            for (auto& data : test_data) {
                util::Xor(data, key_bytes, offset);
            }
        }
        ankerl::nanobench::doNotOptimizeAway(test_data);
    });
}

static void AutoFileXor(benchmark::Bench& bench)
{
    FastRandomContext rng{/*fDeterministic=*/true};
    auto data{rng.randbytes<std::byte>(1'000'000)};

    std::vector<std::byte> empty_key_bytes(8, std::byte{0}); // Test disabled xor
    uint64_t empty_key;
    std::memcpy(&empty_key, empty_key_bytes.data(), 8);

    const fs::path test_path = fs::temp_directory_path() / "xor_benchmark.dat";
    AutoFile f{fsbridge::fopen(test_path, "wb+"), empty_key_bytes};
    bench.batch(data.size()).unit("byte").run([&] {
        f.Truncate(0);
        f << data;
    });
    try { fs::remove(test_path); } catch (const fs::filesystem_error&) {}
}

BENCHMARK(XorHistogram, benchmark::PriorityLevel::HIGH);
BENCHMARK(AutoFileXor, benchmark::PriorityLevel::LOW);
